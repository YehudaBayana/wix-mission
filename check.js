// let list2 = [
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     subject: "General",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "8df8e274-6eab-4ef5-b880-932d727ff50c",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8"><a href="https://docs.google.com/document/d/19VRS6Wv4V29ej9M-2WChty5GsFVQ8fsS2FI0bXwdZsQ/edit#heading=h.b06k1q1tarau"><u>Click here </u></a>to get Forum dummy text from the Template Text Doc</p>',
//     order: 2,
//     whyText: '<p class="font_8"></p>',
//     title: "Wix Forum dummy text link",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_d89f48cc87d241b68fff79c97d59d7fc~mv2.png/105086.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "e3d03ce7-8d07-4b43-9246-d43003e58f1c",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">Forum name, title and description should be added to main page settings by the brief or from Template Text Doc.</p>',
//     order: 3,
//     whyText: '<p class="font_8"></p>',
//     title: "Forum name, title and description were added",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_82daa4bb41dc4dedb3901129c8a5a802~mv2.png/105085.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "53c62f12-6237-4839-8b9c-80b87c445ccf",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">All post name, categories names and post titles should be taken from the template brief and post body content should be taken from the Template text doc.</p>',
//     order: 4,
//     whyText:
//       '<p class="font_8">This content will help users to understand what info should or could be added to their post content. It will also explain how to change or edit it.</p>',
//     title: "Posts body text from Template Text Doc only",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_a6b81622022240a1a27799049f908769~mv2.png/105087.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "66ea5e01-6e12-4300-88d3-02d7367cac21",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">Categories name, title and description should be added to each category page settings by the brief or from Template Text Doc.</p>',
//     order: 5,
//     whyText: '<p class="font_8"></p>',
//     title: "Categories name, title and description were added",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_ed72f8572b384237a779d5300c0d95e9~mv2.png/105088.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "1adce001-8f53-40be-990c-ad652d8dd942",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">After moving the site to the Demonew account, author name should be changed to "Admin". This could only be done on Preview mode on Members "Profile" page. Click "Edit"on Member Profile Card.</p>',
//     order: 6,
//     whyText:
//       '<p class="font_8">On template viewer, users will see the author name on each post and category so it should be default and not "Demonew" or anything else.</p>',
//     title: 'Author name on Demonew should be "Admin"',
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_b914aaef9b364f5d96952d94fcabc366~mv2.png/105089.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "63b80f82-670c-4011-a739-5805e58cb42a",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">On Forum design settings, Icons and buttons - buttons, link & hashtags color should be different from the regular text color. They are also need to be accessible over page BG and vertical menu hover effect on post page should be visible.</p>',
//     order: 7,
//     whyText:
//       '<p class="font_8">This color will give those elements more clickable look and that way on the vertical menu on post page there will be a visible hover effect.</p>',
//     title:
//       "Button, links & hashtags color should be different from regular text color",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_63235ded0f4e4a9594b4fc731cc7cca6~mv2.png/105090.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "5c8f7bb0-9e9a-4888-b419-4d881da667e8",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">When creating a new post, instead of clicking on "start a discussion" click on "Ask a question".</p>',
//     order: 8,
//     whyText:
//       '<p class="font_8">This is a feature that users would love according to the Forum team. They think it should be great to show this feature in templates.</p>',
//     title: "One post at least should be a question type",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     subject: "Members Area",
//     image:
//       "wix:image://v1/82fcd3_0a1a0166156f43759ffe8e8f775b98ad~mv2.png/105091.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "d55de3ab-7ce4-46b0-9166-eb2e4743246b",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">All Forum templates should have a members area and a members login bar on the site header. It should be visible on desktop and mobile. On mobile, login bar can be placed inside mobile menu.</p>',
//     order: 9,
//     whyText:
//       '<p class="font_8">That\'s how site visitors will be able to signup / login to the site and take actions that only members can do like start a discussion or commenting a forum post. Placing the login bar in the header will help them navigate easily through the members pages and get to their personal member pages & info.</p>',
//     title:
//       "Members area was added, login bar is visible on desktop and mobile",
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_2bf50c4ac3d3475dac8225bea0d4f015~mv2.png/105092.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "41d4f59d-b4c4-4c37-8d97-9cdec2ebe8c3",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Thu Jan 20 2022 15:34:14 GMT+0200 (Israel Standard Time)",
//     innerText:
//       '<p class="font_8">When adding a forum to a site, a "Members" page is being added to site pages & menu in addition to the members area inner pages. This page shouldn\'t be hidden. It should be shown on the site menu if required by the brief and if not, should be deleted.</p>',
//     order: 10,
//     whyText:
//       '<p class="font_8">This page allows site members to see all other site members and helps building a community.</p>',
//     title:
//       '"Members" page is visible on site menu if required by the brief. If not, delete it',
//   },
//   {
//     mainCategory: "7aced258-b9af-4e82-a149-3cc24c04be38",
//     image:
//       "wix:image://v1/82fcd3_76433d1afedb4b2fa01ea381beb57b55~mv2.png/105093.png#originWidth=1491&originHeight=973",
//     subCategory: "4de91425-77f5-414d-a945-881be34c1e24",
//     _id: "0731bdd9-9b00-470a-8a39-4acb652c1521",
//     _owner: "82fcd399-30a3-4d7e-83f9-3e47e8df3364",
//     _createdDate:
//       "Thu May 20 2021 23:59:52 GMT+0300 (Israel Daylight Time)",
//     _updatedDate:
//       "Sun Jun 06 2021 14:37:11 GMT+0300 (Israel Daylight Time)",
//     innerText:
//       '<p class="font_8">If template contains a "members" page on site menu, there should be an H1 title text box as page title. Title content should be according to the brief.</p>',
//     order: 105093,
//     whyText:
//       '<p class="font_8">Members page is a widget page and it doesn\'t come with an H1 title option so we should add it manually.</p>',
//     title: "Members page must have an H1 title text box",
//   },
// ];
// let some = [1, 2, 3, 4, 5, 6];
const template = document.createElement("template");
template.innerHTML = `<style>
p{
    font-size: 17px;
}

.container {
background-color: #333;
padding: 1rem;
margin-top: 1rem;
}

.draggable {
padding: 1rem;
background-color: white;
border: 1px solid black;
cursor: move;
}

.draggable.dragging {
opacity: .5;
}
</style>
<button id="button">update order</button>
<div class="container">

</div>`;
class SortableList extends HTMLElement {
  constructor() {
    super();
    this.attachShadow({ mode: "open" });
    this.shadowRoot.appendChild(template.content.cloneNode(true));
    this.container = this.shadowRoot.querySelector(".container");
    this.uniqueId = "newRuleId"
  }

  static get observedAttributes() {
    return ["list-data"];
  }

  attributeChangedCallback(name, oldValue, newValue) {
    if (name === "list-data") {
      this.listData = newValue;
    }
  }

  get listData() {
    return this._listData;
  }

  set listData(d) {
    this._listData = JSON.parse(d);

    sessionStorage.setItem("listData", d);
    if (this._connected) this.updateList();
  }

  async updateList() {
    let list = JSON.parse(this.listData);
    if (!list.some((e) => e._id === this.uniqueId)) {
      list.unshift({ _id: this.uniqueId, order: -1 ,titlefinale:"new rule here"});
    }
    let res = list
      .map((item, i) => {
        let jsonObj = JSON.stringify(item);
        return `<p ${
          item._id === this.uniqueId
            ? 'style="background-color:#1a6d9d; color:white;'
            : null
        } id="id-${i}" class="draggable" draggable="true" data-id=${
          item._id
        }> ${item.titlefinale}</p>`;
      })
      .join("");

    //   res = `<p class="draggable" draggable="true">new rule here <span style="display:none;">"{"slug":"new rule here","order":-1}"</span></p>` + res

    this.container.innerHTML = res;
    for (let i = 0; i < this.container.children.length; i++) {
      if (!this.container.children[i].innerText) {
        this.container.children[i].remove();
      }
    }
  }

  async connectedCallback() {
    let savedData = sessionStorage.getItem("listData");
    if (savedData && savedData !== "undefined" && !this._listData)
      this._listData = savedData;
    this._connected = true;
    if (this._listData) {
      await this.updateList();
    }

    this.draggables = this.shadowRoot.querySelectorAll(".draggable");
    this.container = this.shadowRoot.querySelector(".container");
    this.updateBtn = this.shadowRoot.getElementById("button");

    this.updateBtn.addEventListener("click", () => {
      let allElements = this.container.children;
      let toSend = [];
      for (let i = 0; i < allElements.length; i++) {
        // if (allElements[i].innerText !== "new rule here") {
            let itemId = allElements[i].getAttribute('data-id');
            // console.log(itemId)
            toSend.push({_id:itemId, order:i})
          // }else{
            // toSend.push({ order:i})
          // }  
      }

      this.dispatchEvent(
        new CustomEvent("myEvent", {
          detail: { data: JSON.stringify(toSend) },
        })
      );
    });

    this.draggables.forEach((draggable) => {
      draggable.addEventListener("dragstart", () => {
        draggable.classList.add("dragging");
      });

      draggable.addEventListener("dragend", () => {
        draggable.classList.remove("dragging");
      });
    });

    this.container.addEventListener("dragover", (e) => {
      e.preventDefault();
      const afterElement = getDragAfterElement(this.container, e.clientY);
      const draggable = this.shadowRoot.querySelector(".dragging");
      if (afterElement == null) {
        this.container.appendChild(draggable);
      } else {
        this.container.insertBefore(draggable, afterElement);
      }
    });

    function getDragAfterElement(container, y) {
      const draggableElements = [
        ...container.querySelectorAll(".draggable:not(.dragging)"),
      ];

      return draggableElements.reduce(
        (closest, child) => {
          const box = child.getBoundingClientRect();
          const offset = y - box.top - box.height / 2;
          if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
          } else {
            return closest;
          }
        },
        { offset: Number.NEGATIVE_INFINITY }
      ).element;
    }
  }
}
customElements.define("sortable-list", SortableList);

// let some = [1, 2, 3, 4, 5, 6];
// const template = document.createElement("template");
// template.innerHTML = `<style>
// p{
//     font-size: 17px;
// }

// .container {
// background-color: #333;
// padding: 1rem;
// margin-top: 1rem;
// }

// .draggable {
// padding: 1rem;
// background-color: white;
// border: 1px solid black;
// cursor: move;
// }

// .draggable.dragging {
// opacity: .5;
// }
// </style>
// <button id="button">update order</button>
// <div class="container">

// </div>`;
// class SortableList extends HTMLElement {
//   constructor() {
//     super();
//     this.attachShadow({ mode: "open" });
//     this.shadowRoot.appendChild(template.content.cloneNode(true));
//     this.container = this.shadowRoot.querySelector(".container");
//   }

//   static get observedAttributes() {
//     return ["list-data"];
//   }

//   attributeChangedCallback(name, oldValue, newValue) {
//     if (name === "list-data") {
//       this.listData = newValue;
//     }
//   }

//   get listData() {
//     return this._listData;
//   }

//   set listData(d) {
//     this._listData = JSON.parse(d);

//     sessionStorage.setItem("listData", d);
//     if (this._connected) this.updateList();
//   }

//   async updateList() {
//     let list = JSON.parse(this.listData);
//     if (!list.some((e) => e.title === "new rule here")) {
//       list.unshift({ title: "new rule here", order: -1 });
//     }
//     let res = list
//       .map((item, i) => {
//         let jsonObj = JSON.stringify(item);
//         return `<p ${
//           item.title === "new rule here"
//             ? 'style="background-color:#1a6d9d; color:white;'
//             : null
//         } id="id-${i}" class="draggable" draggable="true" > ${
//           item.title
//         }<span style="display:none;">${
//           jsonObj
//             .split("<p")
//             .join(" ppppp ")
//             .split("</p>")
//             .join(" pcpcp ")
//             .split("<a")
//             .join(" aaaaa ")
//             .split("</a>")
//             .join(" acaca ")
//             .split("<u>")
//             .join(" uuuuu ")
//             .split("</u>")
//             .join(" ucucu ")
//             .split(">")
//             .join(" sogar ")
//         }</span></p>`;
//       })
//       .join("");

//     //   res = `<p class="draggable" draggable="true">new rule here <span style="display:none;">"{"slug":"new rule here","order":-1}"</span></p>` + res

//     this.container.innerHTML = res;
//     for (let i = 0; i < this.container.children.length; i++) {
//       if (!this.container.children[i].innerText) {
//         this.container.children[i].remove();
//       }
//     }
//   }

//   async connectedCallback() {
//     let savedData = sessionStorage.getItem("listData");
//     if (savedData && savedData !== "undefined" && !this._listData)
//       this._listData = savedData;
//     this._connected = true;
//     if (this._listData) {
//       await this.updateList();
//     }

//     this.draggables = this.shadowRoot.querySelectorAll(".draggable");
//     this.container = this.shadowRoot.querySelector(".container");
//     this.updateBtn = this.shadowRoot.getElementById("button");

//     this.updateBtn.addEventListener("click", () => {
//       let allElements = this.container.children;
//       let toSend = [];
//       for (let i = 0; i < allElements.length - 1; i++) {
//         let parsedObj = JSON.parse(
//           allElements[i].firstElementChild.innerHTML
//             .split(" ppppp ")
//             .join("<p")
//             .split(" pcpcp ")
//             .join("</p>")
//             .split(" aaaaa ")
//             .join("<a")
//             .split(" acaca ")
//             .join("</a>")
//             .split(" uuuuu ")
//             .join("<u>")
//             .split(" ucucu ")
//             .join("</u>")
//             .split(" sogar ")
//             .join(">").replace(/&amp;/g, '&')
//         );
//         toSend[i] = parsedObj;
//         toSend[i]["order"] = i;
//       }

//       this.dispatchEvent(
//         new CustomEvent("myEvent", {
//           detail: { data: JSON.stringify(toSend) },
//         })
//       );
//     });

//     this.draggables.forEach((draggable) => {
//       draggable.addEventListener("dragstart", () => {
//         draggable.classList.add("dragging");
//       });

//       draggable.addEventListener("dragend", () => {
//         draggable.classList.remove("dragging");
//       });
//     });

//     this.container.addEventListener("dragover", (e) => {
//       e.preventDefault();
//       const afterElement = getDragAfterElement(this.container, e.clientY);
//       const draggable = this.shadowRoot.querySelector(".dragging");
//       if (afterElement == null) {
//         this.container.appendChild(draggable);
//       } else {
//         this.container.insertBefore(draggable, afterElement);
//       }
//     });

//     function getDragAfterElement(container, y) {
//       const draggableElements = [
//         ...container.querySelectorAll(".draggable:not(.dragging)"),
//       ];

//       return draggableElements.reduce(
//         (closest, child) => {
//           const box = child.getBoundingClientRect();
//           const offset = y - box.top - box.height / 2;
//           if (offset < 0 && offset > closest.offset) {
//             return { offset: offset, element: child };
//           } else {
//             return closest;
//           }
//         },
//         { offset: Number.NEGATIVE_INFINITY }
//       ).element;
//     }
//   }
// }
// customElements.define("sortable-list", SortableList);
